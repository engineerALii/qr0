<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ماسح الشتاء | Winter Scanner</title>
    
    <!-- الخطوط العربية (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- مكتبة Tailwind CSS للتصميم -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- مكتبة FontAwesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- مكتبة QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- تخصيصات Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        ice: '#e0f2fe',
                        frost: 'rgba(255, 255, 255, 0.05)', // تم تخفيف الشفافية للوضع الداكن
                        deepBlue: '#020617' // لون أغمق
                    },
                    animation: {
                        'scan-line': 'scan 2s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%' },
                            '50%': { top: '100%' },
                            '100%': { top: '0%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* إعدادات الخلفية الشتوية الداكنة */
        body {
            /* تدرج لوني داكن جداً ليعطي طابع الليل الشتوي */
            background: linear-gradient(to bottom, #000000, #0f172a, #1e293b);
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* تأثير الثلج */
        .snowflake {
            position: fixed;
            top: -10px;
            color: rgba(255, 255, 255, 0.7); /* تقليل سطوع الثلج قليلاً */
            opacity: 0.6;
            pointer-events: none;
            z-index: 1;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(105vh);
            }
        }

        /* تنسيق منطقة الماسح - مربع كامل */
        #reader {
            width: 100% !important;
            height: 100% !important;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; /* ملء المربع بالكامل */
            border-radius: 1rem;
        }

        /* إخفاء عناصر المكتبة الافتراضية غير المرغوبة */
        #reader__dashboard_section_csr span, 
        #reader__dashboard_section_swaplink {
            display: none !important;
        }

        /* تأثير الزجاج الداكن (Dark Glassmorphism) */
        .glass-panel {
            background: rgba(0, 0, 0, 0.4); /* خلفية سوداء شفافة */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); /* حدود خفيفة جداً */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* زر الفلاش */
        .action-btn {
            transition: all 0.3s ease;
        }
        .action-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen text-slate-200 flex flex-col items-center justify-start py-8 px-4 relative">

    <!-- حاوية الثلوج -->
    <div id="snow-container"></div>

    <!-- العنوان -->
    <header class="z-10 text-center mb-8 animate-fade-in-down">
        <div class="inline-block p-3 rounded-full glass-panel mb-2 border border-cyan-900/30">
            <i class="fa-solid fa-snowflake text-2xl text-cyan-500 animate-spin-slow"></i>
        </div>
        <p class="text-slate-400 text-sm mt-1 font-light tracking-wide">امسح الكود ضوئياً</p>
    </header>

    <!-- البطاقة الرئيسية -->
    <main class="w-full max-w-sm glass-panel rounded-3xl p-5 z-10 flex flex-col gap-6 shadow-2xl relative">
        
        <!-- منطقة الكاميرا (مربع كامل) -->
        <div class="relative w-full aspect-square bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/5 group">
            
            <!-- وعاء مكتبة QR -->
            <div id="reader" class="w-full h-full"></div>

            <!-- خط المسح الليزري -->
            <div id="scan-laser" class="absolute left-0 w-full h-0.5 bg-gradient-to-r from-transparent via-cyan-500 to-transparent shadow-[0_0_20px_rgba(6,182,212,0.9)] z-20 hidden animate-scan-line"></div>
            
            <!-- حالة الكاميرا (عندما تكون مغلقة) -->
            <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 z-10 bg-black/80 backdrop-blur-sm">
                <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4 animate-pulse">
                    <i class="fa-solid fa-camera text-3xl text-white/40"></i>
                </div>
                <button onclick="startScanner()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-8 py-3 rounded-full shadow-lg shadow-cyan-900/50 transition-all font-semibold active:scale-95 tracking-wide">
                    تشغيل الماسح
                </button>
            </div>

            <!-- أركان التحديد (زوايا المربع - تم جعلها أكثر دقة) -->
            <div class="absolute top-5 left-5 w-6 h-6 border-t-2 border-l-2 border-cyan-500/80 rounded-tl-lg z-20 pointer-events-none"></div>
            <div class="absolute top-5 right-5 w-6 h-6 border-t-2 border-r-2 border-cyan-500/80 rounded-tr-lg z-20 pointer-events-none"></div>
            <div class="absolute bottom-5 left-5 w-6 h-6 border-b-2 border-l-2 border-cyan-500/80 rounded-bl-lg z-20 pointer-events-none"></div>
            <div class="absolute bottom-5 right-5 w-6 h-6 border-b-2 border-r-2 border-cyan-500/80 rounded-br-lg z-20 pointer-events-none"></div>
        </div>

        <!-- أزرار التحكم (تم إزالة زر التبديل) -->
        <div class="flex justify-center items-center gap-8">
            <!-- زر الفلاش -->
            <button onclick="toggleFlash()" id="flash-btn" class="action-btn flex flex-col items-center gap-2 text-slate-400 hover:text-yellow-400 disabled:opacity-20 disabled:cursor-not-allowed group">
                <div class="w-12 h-12 rounded-full bg-white/5 border border-white/10 flex items-center justify-center group-hover:bg-white/10 transition-colors">
                    <i class="fa-solid fa-bolt text-lg transition-transform group-active:scale-110"></i>
                </div>
                <span class="text-[10px] font-light">فلاش</span>
            </button>

            <!-- زر الإيقاف (يظهر فقط عند التشغيل) -->
            <button onclick="stopScanner()" id="stop-btn" class="hidden action-btn flex flex-col items-center gap-2 text-slate-400 hover:text-red-400 group">
                <div class="w-14 h-14 rounded-full bg-red-500/10 border border-red-500/30 flex items-center justify-center group-hover:bg-red-500/20 shadow-lg shadow-red-900/20 transition-colors">
                    <i class="fa-solid fa-stop text-xl"></i>
                </div>
                <span class="text-[10px] font-light">إيقاف</span>
            </button>
        </div>

    </main>

    <!-- نافذة النتيجة (Modal) - تصميم داكن -->
    <div id="result-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <!-- طبقة التعتيم الخلفية -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closeModal()"></div>
        
        <!-- محتوى النافذة -->
        <div class="bg-[#0f172a] w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 border-t sm:border border-white/10 shadow-2xl transform translate-y-full sm:translate-y-10 transition-transform duration-300 pointer-events-auto flex flex-col gap-5 relative ring-1 ring-white/5">
            <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-1 sm:hidden"></div>
            
            <div class="text-center mt-2">
                <div class="w-14 h-14 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-400 ring-1 ring-emerald-500/20">
                    <i class="fa-solid fa-check text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-white">تم التقاط الكود</h3>
            </div>

            <div class="bg-black/40 p-5 rounded-2xl border border-white/5 break-all text-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <p id="scanned-text" class="text-cyan-200 font-mono text-sm leading-relaxed relative z-10">...</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="copyResult()" class="col-span-1 bg-slate-800 hover:bg-slate-700 text-slate-200 py-3.5 rounded-xl font-medium transition-colors flex items-center justify-center gap-2 border border-white/5">
                    <i class="fa-regular fa-copy"></i> نسخ
                </button>
                <a id="open-link-btn" href="#" target="_blank" class="hidden col-span-1 bg-cyan-700 hover:bg-cyan-600 text-white py-3.5 rounded-xl font-medium transition-colors flex items-center justify-center gap-2 shadow-lg shadow-cyan-900/30">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> فتح
                </a>
                <button id="close-btn-full" onclick="closeModal()" class="col-span-2 bg-transparent hover:bg-white/5 text-slate-400 hover:text-white py-3 rounded-xl font-medium transition-colors border border-dashed border-white/10 hover:border-white/20">
                    مسح كود آخر
                </button>
            </div>
        </div>
    </div>

    <!-- سجل المسح -->
    <section class="w-full max-w-sm mt-8 z-10 animate-fade-in-up">
        <h3 class="text-slate-500 text-xs font-bold mb-4 px-2 flex items-center gap-2 uppercase tracking-wider">
            <i class="fa-solid fa-clock-rotate-left"></i> المحفوظات
        </h3>
        <div id="history-list" class="flex flex-col gap-2.5 pb-20">
            <!-- سيتم إضافة العناصر هنا بواسطة JS -->
            <div id="empty-history" class="text-center text-slate-600 py-6 glass-panel rounded-2xl border-dashed">
                <i class="fa-regular fa-folder-open text-2xl mb-2 opacity-50"></i>
                <p class="text-xs">السجل فارغ</p>
            </div>
        </div>
    </section>

    <!-- تذييل -->
    <footer class="fixed bottom-0 w-full text-center py-4 text-[10px] text-slate-600 z-10 glass-panel border-t border-white/5 backdrop-blur-xl">
        Winter Scanner &copy; 2025
    </footer>

    <script>
        // --- 1. تأثير الثلج ---
        function createSnow() {
            const container = document.getElementById('snow-container');
            const snowflake = document.createElement('div');
            snowflake.classList.add('snowflake');
            
            // اختيار شكل عشوائي للثلج
            snowflake.innerHTML = Math.random() > 0.6 ? '❄' : '•';
            
            // خصائص عشوائية
            snowflake.style.left = Math.random() * 100 + 'vw';
            snowflake.style.fontSize = Math.random() * 8 + 8 + 'px'; // حجم أصغر قليلاً
            snowflake.style.animationDuration = Math.random() * 5 + 3 + 's'; // حركة أبطأ
            snowflake.style.opacity = Math.random() * 0.5 + 0.1;
            
            container.appendChild(snowflake);
            
            setTimeout(() => {
                snowflake.remove();
            }, 8000);
        }

        setInterval(createSnow, 300); // كثافة أقل قليلاً للهدوء


        // --- 2. إعدادات الماسح ---
        let html5QrCode;
        let isScanning = false;
        let currentCameraId = null;
        const beepSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a');

        function initScanner() {
            html5QrCode = new Html5Qrcode("reader");
        }

        async function startScanner() {
            try {
                document.getElementById('camera-placeholder').style.display = 'none';
                document.getElementById('scan-laser').classList.remove('hidden');
                document.getElementById('stop-btn').classList.remove('hidden');
                
                // للحصول على مربع كامل، نستخدم أبعاد العنصر الأب
                // ونطلب من المكتبة ملء المساحة بالكامل
                const containerWidth = document.getElementById('reader').offsetWidth;
                
                // إعدادات محسنة للملء الكامل
                const config = { 
                    fps: 10, 
                    // نجعل الصندوق بحجم الحاوية تقريباً لضمان المسح في كامل الصورة
                    qrbox: { width: containerWidth * 0.8, height: containerWidth * 0.8 },
                    aspectRatio: 1.0,
                    // هذه الخاصية مهمة للملء
                    videoConstraints: {
                        facingMode: "environment",
                        aspectRatio: 1.0
                    }
                };
                
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess, 
                    onScanFailure
                );
                
                isScanning = true;
                
            } catch (err) {
                console.error("Error starting scanner", err);
                alert("يرجى السماح بالوصول للكاميرا.\n" + err);
                stopScanner();
            }
        }

        function stopScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('camera-placeholder').style.display = 'flex';
                    document.getElementById('scan-laser').classList.add('hidden');
                    document.getElementById('stop-btn').classList.add('hidden');
                }).catch(err => console.error("Failed to stop", err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            beepSound.play().catch(e => {}); 
            showResultModal(decodedText);
            addToHistory(decodedText);
        }

        function onScanFailure(error) {
            // صامت
        }

        // --- 3. الفلاش ---
        let isFlashOn = false;
        async function toggleFlash() {
            if (!isScanning) return;
            
            try {
                 if(html5QrCode.applyVideoConstraints) {
                     await html5QrCode.applyVideoConstraints({
                         advanced: [{ torch: !isFlashOn }]
                     });
                     isFlashOn = !isFlashOn;
                     
                     const btnIcon = document.querySelector('#flash-btn i');
                     const btnDiv = document.querySelector('#flash-btn div');
                     
                     if(isFlashOn) {
                         btnIcon.classList.add('text-yellow-400');
                         btnDiv.classList.add('bg-yellow-400/10', 'border-yellow-400/50');
                     } else {
                         btnIcon.classList.remove('text-yellow-400');
                         btnDiv.classList.remove('bg-yellow-400/10', 'border-yellow-400/50');
                     }
                 } else {
                     alert("الفلاش غير مدعوم.");
                 }
            } catch (err) {
                console.error(err);
                alert("لا يمكن تشغيل الفلاش.");
            }
        }

        // --- 4. واجهة النتائج (Modal) ---
        const modal = document.getElementById('result-modal');
        const modalContent = modal.querySelector('div.bg-\\[\\#0f172a\\]'); // Selector needs adjustment for arbitrary values or just use generic
        const scannedTextEl = document.getElementById('scanned-text');
        const openLinkBtn = document.getElementById('open-link-btn');
        const closeBtnFull = document.getElementById('close-btn-full');

        function showResultModal(text) {
            scannedTextEl.innerText = text;
            
            const isUrl = /^(http|https):\/\/[^ "]+$/.test(text);
            
            if (isUrl) {
                openLinkBtn.href = text;
                openLinkBtn.classList.remove('hidden');
                openLinkBtn.classList.add('flex');
                closeBtnFull.classList.remove('col-span-2');
                closeBtnFull.classList.add('col-span-1');
            } else {
                openLinkBtn.classList.add('hidden');
                openLinkBtn.classList.remove('flex');
                closeBtnFull.classList.remove('col-span-1');
                closeBtnFull.classList.add('col-span-2');
            }

            modal.style.opacity = '1';
            modal.style.pointerEvents = 'auto';
            
            setTimeout(() => {
                // نستخدم querySelector مباشر للعنصر الداخلي
                modal.children[1].style.transform = window.innerWidth < 640 ? 'translateY(0)' : 'translateY(0)';
            }, 10);
        }

        function closeModal() {
            modal.children[1].style.transform = window.innerWidth < 640 ? 'translateY(100%)' : 'translateY(10rem)';
            setTimeout(() => {
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
            }, 300);
        }

        async function copyResult() {
            const text = scannedTextEl.innerText;
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.querySelector('#result-modal button i.fa-copy').parentNode;
                const originalHTML = btn.innerHTML;
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> تم';
                btn.classList.remove('bg-slate-800', 'text-slate-200');
                btn.classList.add('bg-emerald-600', 'text-white');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.add('bg-slate-800', 'text-slate-200');
                    btn.classList.remove('bg-emerald-600', 'text-white');
                }, 2000);
            } catch (err) {
                alert('فشل النسخ');
            }
        }

        // --- 5. السجل ---
        function getHistory() {
            return JSON.parse(localStorage.getItem('qr_winter_history') || '[]');
        }

        function addToHistory(text) {
            let history = getHistory();
            const newItem = {
                text: text,
                date: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                type: /^(http|https):/.test(text) ? 'link' : 'text'
            };
            
            if (history.length > 0 && history[0].text === text) return;

            history.unshift(newItem);
            if (history.length > 10) history.pop();
            
            localStorage.setItem('qr_winter_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = getHistory();
            const emptyState = document.getElementById('empty-history');

            if (history.length === 0) {
                emptyState.style.display = 'block';
                list.innerHTML = '';
                list.appendChild(emptyState);
                return;
            }

            emptyState.style.display = 'none';
            
            let html = '';
            history.forEach(item => {
                const icon = item.type === 'link' ? 'fa-link' : 'fa-align-left';
                const colorClass = item.type === 'link' ? 'text-cyan-400' : 'text-slate-500';
                
                html += `
                <div class="glass-panel p-3 rounded-xl flex items-center justify-between animate-fade-in-up hover:bg-white/5 transition-colors border-0 border-b border-white/5 last:border-0">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-black/40 flex items-center justify-center shrink-0">
                            <i class="fa-solid ${icon} ${colorClass} text-[10px]"></i>
                        </div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-[10px] text-slate-500 font-mono">${item.date}</span>
                            <span class="text-xs text-slate-300 truncate max-w-[180px]">${item.text}</span>
                        </div>
                    </div>
                    <button onclick="navigator.clipboard.writeText('${item.text}')" class="text-slate-600 hover:text-white p-2 transition-colors">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                </div>
                `;
            });
            
            list.innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initScanner();
            renderHistory();
        });

    </script>
</body>
</html>
